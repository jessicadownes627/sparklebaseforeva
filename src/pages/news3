// src/pages/News.jsx
import React, { useEffect, useState } from "react";
import { useNavigate } from "react-router-dom";
import { useUser } from "../context/UserContext";

import TapIntoCard from "../components/TapIntoCard";
import LiveWireSection from "../components/news/LiveWireSection";
import HotSheetSection from "../components/news/HotSheetSection";
import SportsSection from "../components/news/SportsSection";
import ConversationDeckSection from "../components/news/ConversationDeckSection";
import BrighterSideSection from "../components/news/BrighterSideSection";
import PocketCompanionSection from "../components/news/PocketCompanionSection";
import Footer from "../components/Footer";

// ✅ utils for live + fallback
import { getLiveWireHeadlinesFromNewsData } from "../utils/getLiveWireHeadlinesFromNewsData";
import { fetchHotSheetFromSheet } from "../utils/fetchHotSheetFromSheet";
import { fetchThingsWeLoveFromSheet } from "../utils/fetchThingsWeLoveFromSheet";
import { fetchBigGamesFromSheet } from "../utils/fetchBigGamesFromSheet";
import { getTAPintoHeadlinesForCity } from "../utils/rssFeeds";

// ✅ local data for safety
import conversationDeck from "../data/conversationDeck";
import topicEmojiMap from "../data/topicEmojiMap";
import pocketCompanionDeck from "../data/pocketCompanionDeck";
import curatedFallbacks from "../data/curatedFallbacks";

export default function News() {
  const navigate = useNavigate();
  const { userData } = useUser();
  const [liveHeadlines, setLiveHeadlines] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    async function loadHeadlines() {
      try {
        const results = await getLiveWireHeadlinesFromNewsData(userData?.topics || []);
        if (results && results.length > 0) {
          setLiveHeadlines(results);
        } else {
          setLiveHeadlines(curatedFallbacks); // fallback if nothing live
        }
      } catch (err) {
        console.error("Live headlines failed:", err);
        setLiveHeadlines(curatedFallbacks);
      } finally {
        setLoading(false);
      }
    }
    loadHeadlines();
  }, [userData?.topics]);

  return (
    <div className="news-page">
      {/* TAPinto first */}
      <TapIntoCard userData={userData} />

      {/* LiveWire */}
      <LiveWireSection headlines={liveHeadlines} loading={loading} />

      {/* Hot Sheet */}
      <HotSheetSection />

      {/* 3-column layout: Sports / Conversation / Brighter Side */}
      <div className="three-col">
        <SportsSection />
        <ConversationDeckSection deck={conversationDeck} />
        <BrighterSideSection />
      </div>

      {/* Rapid Fire / Pocket Companion */}
      <PocketCompanionSection deck={pocketCompanionDeck} />

      {/* Footer */}
      <Footer />
    </div>
  );
}

